<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Mascotas</title>

  <style>
    /* ======== MODAL OVERLAY ======== */
  .modal-overlay {
    display: none; 
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    z-index: 999;
  }

  /* ======== MODAL ======== */
  .modal {
    background: white;
    width: 95%;
    max-width: 450px;
    padding: 25px;
    border-radius: 18px;
    position: relative;
    animation: fadeIn 0.25s ease;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }

  .modal-title {
    font-size: 22px;
    margin-bottom: 15px;
    font-weight: 700;
    text-align: center;
  }

  /* ======== BOTÓN CERRAR ======== */
  .btn-close {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 15px;
  }

  .btn-close:hover {
    background: #c0392b;
  }

  /* ======== BOTÓN GUARDAR ======== */
  .btn-save {
    background: #2ecc71;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
  }

  .btn-save:hover {
    background: #27ae60;
  }

  @keyframes fadeIn {
    from { transform: scale(0.9); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
  }

    /* ======== RESET ======== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
    }

    body {
      background: #f4f6f9;
      padding: 25px;
      color: #2d3436;
    }

    h1 {
      font-size: 30px;
      margin-bottom: 20px;
    }

    /* ======== BOTÓN VOLVER ======== */
    .btn-back {
      background: #d63031;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 20px;
      transition: 0.2s;
    }

    .btn-back:hover {
      background: #b32626;
    }

    /* ======== BOTÓN AGREGAR ======== */
    .btn-toggle {
      background: #0984e3;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }

    .btn-toggle:hover {
      background: #0a6fbd;
    }

    /* ======== FORMULARIO ======== */
    form {
      display: none;
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0px 8px 20px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 500px;
    }

    input, select, button[type="submit"] {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #dcdde1;
      background: #fafafa;
      font-size: 15px;
      transition: 0.2s;
    }

    input:focus, select:focus {
      border-color: #0984e3;
      box-shadow: 0 0 0 3px rgba(0,132,227,0.25);
      outline: none;
      background: #fff;
    }

    button[type="submit"] {
      background: #2ecc71;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    button[type="submit"]:hover {
      background: #27ae60;
    }

    /* ======== BUSCADOR DUEÑO ======== */
    .dueno-container {
      position: relative;
    }

    #duenoList {
      border: 1px solid #ccc;
      position: absolute;
      background: white;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      border-radius: 8px;
      display: none;
      z-index: 50;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
    }

    #duenoList div {
      padding: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    #duenoList div:hover {
      background: #f1faff;
    }

    /* ======== TABLA ======== */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 25px;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0px 8px 20px rgba(0,0,0,0.06);
    }

    th {
      background: #0984e3;
      color: white;
      padding: 14px;
      text-align: left;
      font-size: 15px;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    tr:hover {
      background: #f1faff;
    }

    /* Botones de acciones */
    .btn-edit {
      background: #f1c40f;
      color: white;
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-edit:hover {
      background: #d4ac0d;
    }

    .btn-delete {
      background: #e74c3c;
      color: white;
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-delete:hover {
      background: #c0392b;
    }

    /* RESPONSIVE */
    @media(max-width: 600px) {
      form {
        width: 100%;
      }

      table {
        font-size: 14px;
      }
    }
  </style>
</head>

<body>

  <button class="btn-back" onclick="window.location.href='dashboard.html'">⬅ Volver atrás</button>

  <h1>Gestión de Mascotas</h1>

<!-- BOTÓN PARA ABRIR EL MODAL -->
<button class="btn-toggle" onclick="openModal()">➕ Agregar Mascota</button>

<!-- OVERLAY DEL MODAL -->
<div id="modalOverlay" class="modal-overlay">

  <!-- CONTENIDO DEL MODAL -->
  <div class="modal">

    <h2 class="modal-title">Agregar / Editar Mascota</h2>

    <form id="mascotaForm">

      <input type="hidden" id="mascotaId" />

      <input type="text" id="nombre" placeholder="Nombre" required />

      <select id="especie" required>
        <option value="">Seleccioná una especie</option>
        <option value="Perro">Perro</option>
        <option value="Gato">Gato</option>
        <option value="Loro">Loro</option>
        <option value="Conejo">Conejo</option>
        <option value="Otro">Otro</option>
      </select>

      <input type="number" id="edad" placeholder="Edad" required />

      <!-- Buscador de dueño -->
      <div class="dueno-container">
        <input type="text" id="duenoNombre" placeholder="Nombre del dueño" autocomplete="off" required />
        <input type="hidden" id="dueno_id" />
        <div id="duenoList"></div>
      </div>

      <button type="submit" class="btn-save">Guardar</button>
    </form>

    <button class="btn-close" onclick="closeModal()">✖</button>

  </div>
</div>

  <!-- TABLA -->
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Especie</th>
        <th>Edad</th>
        <th>Dueño</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaMascotas"></tbody>
  </table>

<script>
const form = document.getElementById('mascotaForm');
const tabla = document.getElementById('tablaMascotas');
const duenoNombre = document.getElementById('duenoNombre');
const duenoList = document.getElementById('duenoList');
const dueno_id = document.getElementById('dueno_id');

function toggleForm() {
  form.style.display = form.style.display === 'none' ? 'flex' : 'none';
}

async function cargarMascotas() {
  const res = await fetch('http://localhost:3000/mascotas');
  const data = await res.json();
  tabla.innerHTML = data.map(m => `
    <tr>
      <td>${m.id}</td>
      <td>${m.nombre}</td>
      <td>${m.especie}</td>
      <td>${m.edad}</td>
      <td>${m.usuario?.nombre ?? 'Sin dueño'}</td>
      <td>
        <button onclick="editar(${m.id}, '${m.nombre}', '${m.especie}', ${m.edad}, ${m.usuario_id}, '${m.usuario?.nombre ?? ''}')">Editar</button>
        <button onclick="eliminar(${m.id})">Eliminar</button>
      </td>
    </tr>
  `).join('');
}

// Buscador de dueños con autocomplete
let timeout;
duenoNombre.addEventListener('input', () => {
  clearTimeout(timeout);
  const query = duenoNombre.value.trim();
  if (!query) { 
    duenoList.style.display = 'none'; 
    return; 
  }

  timeout = setTimeout(async () => {
    const res = await fetch(`http://localhost:3000/usuarios/search?nombre=${encodeURIComponent(query)}`);
    const usuarios = await res.json();
    duenoList.innerHTML = usuarios.map(u => `<div data-id="${u.id}">${u.nombre} ${u.apellido}</div>`).join('');
    duenoList.style.display = usuarios.length ? 'block' : 'none';
  }, 300);
});

// Selección de dueño del listado
duenoList.addEventListener('click', (e) => {
  if (e.target.dataset.id) {
    duenoNombre.value = e.target.textContent;
    dueno_id.value = e.target.dataset.id;
    duenoList.style.display = 'none';
  }
});

// Envío de formulario
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('mascotaId').value;
  const data = {
    nombre: document.getElementById('nombre').value,
    especie: document.getElementById('especie').value,
    edad: Number(document.getElementById('edad').value),
    dueno_id: Number(dueno_id.value),
  };
  const method = id ? 'PUT' : 'POST';
  const url = id ? `http://localhost:3000/mascotas/${id}` : 'http://localhost:3000/mascotas';

  await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  form.reset();
  form.style.display = 'none';
  cargarMascotas();
});

// Función para editar mascota
function editar(id, nombre, especie, edad, idDueno, nombreDueno) {
  document.getElementById('mascotaId').value = id;
  document.getElementById('nombre').value = nombre;
  document.getElementById('especie').value = especie;
  document.getElementById('edad').value = edad;
  duenoNombre.value = nombreDueno;
  dueno_id.value = idDueno;
  form.style.display = 'flex';
}

function openModal() {
  document.getElementById("modalOverlay").style.display = "flex";
}

function closeModal() {
  document.getElementById("modalOverlay").style.display = "none";
  document.getElementById("mascotaForm").reset();
  document.getElementById("mascotaId").value = "";
}

// Función para eliminar mascota
async function eliminar(id) {
  await fetch(`http://localhost:3000/mascotas/${id}`, { method: 'DELETE' });
  cargarMascotas();
}

cargarMascotas();

</script>
</body>
</html>
