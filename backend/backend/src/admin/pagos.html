<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gesti√≥n de Pagos - Pelucan</title>

    <style>
      /* -------- GENERAL -------- */
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #f2f2f2;
        padding: 0;
        margin: 0;
      }

      h2 {
        margin: 20px 0;
        text-align: center;
        color: #333;
      }


      /* -------- BOTONES -------- */
      .btn {
        padding: 10px 16px;
        background: #222;
        color: white;
        border: none;
        border-radius: 6px;
        margin: 8px 5px;
        cursor: pointer;
        transition: 0.2s;
      }

      .btn:hover {
        background: #000;
      }

      .btn-warning {
        background: #e8b000;
      }
      .btn-danger {
        background: #c62828;
      }

      /* -------- TABLA -------- */
      table {
        width: 95%;
        margin: 25px auto;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
      }

      th {
        background: #222;
        color: white;
        padding: 12px;
      }

      td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }

      tr:hover {
        background: #f1f1f1;
      }

      /* -------- MODAL -------- */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(3px);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        width: 420px;
        padding: 25px;
        border-radius: 12px;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .close {
        float: right;
        font-size: 22px;
        cursor: pointer;
      }

      /* -------- FORMULARIO -------- */
      form label {
        font-weight: bold;
        margin-top: 10px;
        display: block;
      }

      form input,
      form select {
        width: 100%;
        padding: 9px;
        margin-top: 5px;
        border-radius: 6px;
        border: 1px solid #bbb;
        background: #fafafa;
      }

      form button {
        width: 100%;
        margin-top: 15px;
      }
    </style>
  </head>

  <body>

    <h2>Gesti√≥n de Pagos</h2>

    <div style="text-align: center">
      <button class="btn" onclick="abrirModalPago()">‚ûï Agregar Pago</button>
      <button class="btn btn-warning" onclick="history.back()">
        ‚¨Ö Volver
      </button>
    </div>

    <!-- ------------------ MODAL ------------------ -->
    <div id="modalPago" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarModalPago()">&times;</span>
        <h3 style="text-align: center">Registrar Pago</h3>

        <form id="formPago">
          <input type="hidden" id="id" />

          <label>Monto:</label>
          <input type="number" id="monto" step="0.01" required />

          <label>M√©todo de Pago:</label>
          <select id="metodo" required>
            <option value="">Seleccione...</option>
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
            <option value="transferencia">Transferencia</option>
          </select>

          <label>Turno asociado:</label>
          <select id="turno_id" required>
            <option value="">Seleccione...</option>
          </select>

          <button class="btn" type="submit">Guardar</button>
          <button
            class="btn btn-danger"
            type="button"
            onclick="cerrarModalPago()"
          >
            Cancelar
          </button>
        </form>
      </div>
    </div>

    <!-- ------------------ TABLA ------------------ -->
    <table id="tablaPagos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Monto</th>
          <th>M√©todo</th>
          <th>Fecha</th>
          <th>Turno</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <script>
      const API = 'http://localhost:3000/pagos';
      const TURNOS_API = 'http://localhost:3000/turnos';
      const form = document.getElementById('formPago');
      const tbody = document.querySelector('#tablaPagos tbody');

      // Mostrar / Ocultar formulario
      function mostrarFormulario() {
        form.style.display = 'block';
      }
      function ocultarFormulario() {
        form.style.display = 'none';
        form.reset();
      }

      // Cargar Turnos en el select
      async function cargarTurnos() {
        const res = await fetch(TURNOS_API);
        const data = await res.json();
        const selectTurno = document.getElementById('turno_id');
        selectTurno.innerHTML =
          '<option value="">Seleccione un turno...</option>';
        data.forEach((t) => {
          const fechaObj = new Date(t.fecha);
          const fechaFormateada = `${fechaObj.getDate().toString().padStart(2, '0')}/${(fechaObj.getMonth() + 1).toString().padStart(2, '0')}/${fechaObj.getFullYear()}`;
          selectTurno.innerHTML += `<option value="${t.id}">${t.id} - ${t.usuario?.nombre || 'Sin cliente'} (${fechaFormateada})</option>`;
        });
      }

      // Cargar Pagos
      async function cargarPagos() {
        const res = await fetch(API);
        const data = await res.json();
        tbody.innerHTML = '';
        data.forEach((p) => {
          const fecha = new Date(p.fecha_pago).toLocaleDateString();
          tbody.innerHTML += `
      <tr>
        <td>${p.id}</td>
        <td>$${p.monto.toFixed(2)}</td>
        <td>${p.metodo}</td>
        <td>${fecha}</td>
        <td>${p.turno_id || 'N/A'}</td>
        <td>
          <button onclick="editar(${p.id}, ${p.monto}, '${p.metodo}', ${p.turno_id})">‚úèÔ∏è</button>
          <button onclick="eliminar(${p.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
        });
      }

      // Editar pago
      function editar(id, monto, metodo, turno_id) {
        mostrarFormulario();
        document.getElementById('id').value = id;
        document.getElementById('monto').value = monto;
        document.getElementById('metodo').value = metodo;
        document.getElementById('turno_id').value = turno_id;
      }

      // Eliminar pago
      async function eliminar(id) {
        if (confirm('¬øEliminar pago?')) {
          await fetch(`${API}/${id}`, { method: 'DELETE' });
          cargarPagos();
        }
      }

      function abrirModalPago() {
        document.getElementById('modalPago').style.display = 'flex';
      }

      function cerrarModalPago() {
        document.getElementById('modalPago').style.display = 'none';
        document.getElementById('formPago').reset();
      }

      // Cerrar con clic afuera
      window.onclick = function (e) {
        const modal = document.getElementById('modalPago');
        if (e.target === modal) modal.style.display = 'none';
      };

      // Guardar pago
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('id').value;
        const datos = {
          monto: parseFloat(document.getElementById('monto').value),
          metodo: document.getElementById('metodo').value,
          turno_id: Number(document.getElementById('turno_id').value),
        };

        let res;
        if (id) {
          res = await fetch(`${API}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos),
          });
        } else {
          res = await fetch(API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos),
          });
        }

        if (!res.ok) {
          alert('Error al guardar el pago.');
          return;
        }

        ocultarFormulario();
        cargarPagos();
      });

      // Inicializaci√≥n
      cargarTurnos();
      cargarPagos();
    </script>
  </body>
</html>
