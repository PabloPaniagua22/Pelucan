<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Turnos - Pelucan</title>
<style>
  body { font-family: Arial; padding: 20px; }
  input, button, select { margin: 5px; padding: 8px; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  #formTurno { display: none; margin-top: 20px; }
  datalist option { padding: 5px; }
</style>
</head>

<!-- Barra de navegaci√≥n -->
<nav style="background-color: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px;">
  <div style="font-weight: bold; font-size: 18px;">üíà Pelucan</div>
  <div>
    <a href="admin.html" style="color: white; text-decoration: none; margin-right: 15px;">Inicio</a>
    <a href="turnos.html" style="color: white; text-decoration: none; margin-right: 15px;">Turnos</a>
    <a href="usuarios.html" style="color: white; text-decoration: none; margin-right: 15px;">Usuarios</a>
    <a href="servicios.html" style="color: white; text-decoration: none;">Servicios</a>
  </div>
</nav>

<body>

<h2>Gesti√≥n de Turnos</h2>

<!-- Botones de acci√≥n -->
<button onclick="mostrarFormulario()">Agregar Turno</button>
<button onclick="window.history.back()">‚¨ÖÔ∏è Volver</button>

<!-- Formulario oculto -->
<form id="formTurno">
  <input type="hidden" id="id">
  
  <label for="dia">Fecha:</label>
  <input type="date" id="dia" required>

  <label for="hora">Hora:</label>
  <input type="time" id="hora" required>

  <select id="estado">
    <option value="Pendiente">Pendiente</option>
    <option value="Confirmado">Confirmado</option>
    <option value="Cancelado">Cancelado</option>
    <option value="Completado">Completado</option>
  </select>

  <label for="usuario_nombre">Cliente:</label> 
  <input list="usuarios" id="usuario_nombre" placeholder="Buscar cliente..." required>
  <datalist id="usuarios"></datalist>

  <label for="servicio_id">Servicio:</label>
  <select id="servicio_id" required>
    <option value="">Seleccione un servicio...</option>
  </select>

  <label for="medio_pago">Medio de Pago:</label>
  <select id="medio_pago" required>
    <option value="">Seleccione un medio de pago...</option>
    <option value="Efectivo">Efectivo</option>
    <option value="Tarjeta">Tarjeta</option>
    <option value="Transferencia">Transferencia</option>
  </select>

  <button type="submit">Guardar</button>
  <button type="button" onclick="ocultarFormulario()">Cancelar</button>
</form>

<!-- Tabla de turnos -->
<table id="tablaTurnos">
  <thead><tr><th>ID</th><th>Fecha</th><th>Hora</th><th>Usuario</th><th>Servicio</th><th>Estado</th><th>Acciones</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const API_TURNOS = "http://localhost:3000/turnos";
const API_USUARIOS = "http://localhost:3000/usuarios";
const API_SERVICIOS = "http://localhost:3000/servicios";

const form = document.getElementById("formTurno");
const tbody = document.querySelector("#tablaTurnos tbody");
const usuariosDatalist = document.getElementById("usuarios");
const servicioSelect = document.getElementById("servicio_id");

let listaUsuarios = []; // Guardamos usuarios en memoria para buscar por nombre

// Mostrar/Ocultar formulario
function mostrarFormulario() { form.style.display = "block"; }
function ocultarFormulario() { form.style.display = "none"; form.reset(); }

// Cargar usuarios y servicios al inicio
async function cargarUsuariosYServicios() {
  try {
    const [usuariosRes, serviciosRes] = await Promise.all([
      fetch(API_USUARIOS),
      fetch(API_SERVICIOS)
    ]);
    const usuarios = await usuariosRes.json();
    const servicios = await serviciosRes.json();

    listaUsuarios = usuarios;
    usuariosDatalist.innerHTML = usuarios.map(u => `<option value="${u.nombre}">`).join('');
    servicioSelect.innerHTML = `<option value="">Seleccione un servicio...</option>` +
      servicios.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
  } catch (err) {
    console.error("Error cargando usuarios o servicios:", err);
    alert("Error cargando datos de usuarios o servicios");
  }
}

// Cargar turnos
async function cargarTurnos() {
  const res = await fetch(API_TURNOS);
  const data = await res.json();
  tbody.innerHTML = "";
  data.forEach(t => {
    const fechaObj = new Date(t.fecha);
    const fechaFormateada = fechaObj.toLocaleDateString("es-AR");
    tbody.innerHTML += `
      <tr>
        <td>${t.id}</td>
        <td>${fechaFormateada}</td>
        <td>${t.hora}</td>
        <td>${t.usuario?.nombre || 'N/A'}</td>
        <td>${t.servicio?.nombre || 'N/A'}</td>
        <td>${t.estado}</td>
        <td>
          <button onclick="editar(${t.id}, '${t.fecha}', '${t.hora}', '${t.estado}', ${t.usuario_id}, ${t.servicio_id})">‚úèÔ∏è</button>
          <button onclick="eliminar(${t.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
  });
}

// Editar turno
function editar(id, fecha, hora, estado, usuario_id, servicio_id) {
  mostrarFormulario();
  const fechaObj = new Date(fecha);
  const dia = String(fechaObj.getDate()).padStart(2, "0");
  const mes = String(fechaObj.getMonth() + 1).padStart(2, "0");
  const anio = fechaObj.getFullYear();
  document.getElementById("id").value = id;
  document.getElementById("dia").value = `${dia}/${mes}/${anio}`;
  document.getElementById("hora").value = hora;
  document.getElementById("estado").value = estado;
  document.getElementById("servicio_id").value = servicio_id;
  
  const usuario = listaUsuarios.find(u => u.id === usuario_id);
  if (usuario) document.getElementById("usuario_nombre").value = usuario.nombre;
}

// Eliminar turno
async function eliminar(id) {
  if (confirm("¬øEliminar turno?")) {
    await fetch(`${API_TURNOS}/${id}`, { method: "DELETE" });
    cargarTurnos();
  }
}

// Guardar turno
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("id").value;

  // Obtener fecha y hora
  const fechaSeleccionada = document.getElementById("dia").value; // yyyy-mm-dd
  const horaValor = document.getElementById("hora").value; // hh:mm
  if (!fechaSeleccionada || !horaValor) {
    alert("Debe ingresar una fecha y hora v√°lidas.");
    return;
  }

  // Combinar fecha y hora y convertir a ISO
  const fechaISO = new Date(`${fechaSeleccionada}T${horaValor}:00`).toISOString();

  // Buscar usuario seleccionado
  const nombreUsuario = document.getElementById("usuario_nombre").value.trim();
  const usuario = listaUsuarios.find(
    u => u.nombre.toLowerCase() === nombreUsuario.toLowerCase()
  );
  if (!usuario) {
    alert("Debe seleccionar un cliente v√°lido de la lista");
    return;
  }

  // Construir objeto a enviar
  const datos = {
    fecha: fechaISO,
    hora: horaValor,
    estado: document.getElementById("estado").value,
    usuario_id: usuario.id,
    servicio_id: Number(document.getElementById("servicio_id").value),
    medio_pago: document.getElementById("medio_pago").value
  };

  try {
    let res;
    if (id) {
      // Actualizar turno existente
      res = await fetch(`${API_TURNOS}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });
    } else {
      // Crear nuevo turno
      res = await fetch(API_TURNOS, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });
    }

    if (res.ok) {
      ocultarFormulario();
      cargarTurnos();
    } else {
      const error = await res.json();
      alert(error.message || "Error al guardar el turno");
    }
  } catch (err) {
    console.error(err);
    alert("Error de conexi√≥n con el servidor.");
  }
});

// Inicial
cargarUsuariosYServicios();
cargarTurnos();
</script>
</body>
</html>
