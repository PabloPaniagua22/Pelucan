<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Usuarios - Pelucan</title>
<style>
  body { font-family: Arial; padding: 20px; }
  input, button { margin: 5px; padding: 8px; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  #formUsuario { display: none; margin-top: 20px; }
</style>
</head>
<body>

<h2>Gesti√≥n de Usuarios</h2>

<button onclick="mostrarFormulario()">Agregar Usuario</button>

<form id="formUsuario">
  <input type="hidden" id="id">
  <input type="text" id="nombre" placeholder="Nombre" required>
  <input type="text" id="apellido" placeholder="Apellido" required>
  <input type="email" id="correo" placeholder="Correo electr√≥nico" required>
  <input type="text" id="telefono" placeholder="Tel√©fono">
  <input type="password" id="contrasena" placeholder="Contrase√±a" required>
  <button type="submit">Guardar</button>
  <button type="button" onclick="ocultarFormulario()">Cancelar</button>
</form>

<table id="tablaUsuarios">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Apellido</th>
      <th>Correo</th>
      <th>Tel√©fono</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="window.history.back()">Volver</button>

<script>
const API = "http://localhost:3000/usuarios";
const form = document.getElementById("formUsuario");
const tbody = document.querySelector("#tablaUsuarios tbody");

function mostrarFormulario() { form.style.display = "block"; }
function ocultarFormulario() { form.style.display = "none"; form.reset(); }

async function cargarUsuarios() {
  const res = await fetch(API);
  const data = await res.json();
  tbody.innerHTML = "";
  data.forEach(u => {
    tbody.innerHTML += `
      <tr>
        <td>${u.id}</td>
        <td>${u.nombre}</td>
        <td>${u.apellido || ''}</td>
        <td>${u.correo}</td>
        <td>${u.telefono || ''}</td>
        <td>
          <button onclick="editar(${u.id}, '${u.nombre}', '${u.apellido}', '${u.correo}', '${u.telefono || ''}', '${u.contrasena || ''}')">‚úèÔ∏è</button>
          <button onclick="eliminar(${u.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
  });
}

function editar(id, nombre, apellido, correo, telefono, contrasena) {
  mostrarFormulario();
  document.getElementById("id").value = id;
  document.getElementById("nombre").value = nombre;
  document.getElementById("apellido").value = apellido;
  document.getElementById("correo").value = correo;
  document.getElementById("telefono").value = telefono;
  document.getElementById("contrasena").value = contrasena;
}

async function eliminar(id) {
  if (confirm("¬øEliminar usuario?")) {
    await fetch(`${API}/${id}`, { method: "DELETE" });
    cargarUsuarios();
  }
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("id").value;
  const datos = {
    nombre: document.getElementById("nombre").value,
    apellido: document.getElementById("apellido").value,
    correo: document.getElementById("correo").value,
    telefono: document.getElementById("telefono").value,
    contrasena: document.getElementById("contrasena").value
  };

  try { // <-- Agregamos try aqu√≠
    let res;
    if (id) {
      res = await fetch(`${API}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });
    } else {
      res = await fetch(API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });
    }

    const resultado = await res.json(); // <-- capturamos la respuesta
    if (!res.ok) { // <-- si el backend devuelve error
      alert(resultado.message); // <-- mostramos el error en pantalla
      return; // no continuamos con reload de tabla
    }

    // Si todo bien, ocultamos el formulario y recargamos
    ocultarFormulario();
    cargarUsuarios();

  } catch (err) { // <-- captura de errores de conexi√≥n u otros
    console.error(err);
    alert("Error de conexi√≥n con el servidor.");
  }
});
cargarUsuarios();
</script>
</body>
</html>
